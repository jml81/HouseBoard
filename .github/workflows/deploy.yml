name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    name: Deploy to Cloudflare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate route tree
        run: pnpm exec tsr generate

      - name: Build
        run: pnpm build

      - name: D1 schema migration
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute houseboard-db --remote --file=db/schema.sql

      - name: D1 add created_by columns (idempotent)
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute houseboard-db --remote --command "ALTER TABLE bookings ADD COLUMN created_by TEXT; ALTER TABLE marketplace_items ADD COLUMN created_by TEXT;"

      - name: D1 add events created_by column (idempotent)
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute houseboard-db --remote --command "ALTER TABLE events ADD COLUMN created_by TEXT;"

      - name: D1 add materials created_by column (idempotent)
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute houseboard-db --remote --command "ALTER TABLE materials ADD COLUMN created_by TEXT;"

      - name: D1 add users status column (idempotent)
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute houseboard-db --remote --command "ALTER TABLE users ADD COLUMN status TEXT NOT NULL DEFAULT 'active';"

      - name: D1 create password_reset_tokens table (idempotent)
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute houseboard-db --remote --command "CREATE TABLE IF NOT EXISTS password_reset_tokens (id TEXT PRIMARY KEY, user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE, token_hash TEXT NOT NULL, expires_at TEXT NOT NULL, used_at TEXT, created_at TEXT NOT NULL DEFAULT (datetime('now'))); CREATE INDEX IF NOT EXISTS idx_prt_user_id ON password_reset_tokens(user_id); CREATE INDEX IF NOT EXISTS idx_prt_token_hash ON password_reset_tokens(token_hash);"

      - name: D1 add marketplace image_key column (idempotent)
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute houseboard-db --remote --command "ALTER TABLE marketplace_items ADD COLUMN image_key TEXT;"

      - name: D1 add meeting_documents file_key column (idempotent)
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute houseboard-db --remote --command "ALTER TABLE meeting_documents ADD COLUMN file_key TEXT;"

      - name: D1 add materials file_key column (idempotent)
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute houseboard-db --remote --command "ALTER TABLE materials ADD COLUMN file_key TEXT;"

      # NOTE: seed.sql is NOT run in CI â€” use `pnpm db:seed:remote` manually when needed.
      # Smoke tests rely on demo users already existing in production D1.

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=houseboard

      - name: Smoke tests
        if: github.event_name == 'push'
        env:
          SMOKE_EMAIL: testaaja@talo.fi
          SMOKE_PASSWORD: ${{ secrets.E2E_RESIDENT_PASSWORD }}
        run: |
          echo "Waiting for edge propagation..."
          for i in 1 2 3 4 5; do
            HEALTH=$(curl -s https://houseboard.pages.dev/api/health)
            if echo "$HEALTH" | grep -q '"status":"ok"'; then
              echo "OK: /api/health responded on attempt $i"
              break
            fi
            echo "Attempt $i: health not ready, waiting 10s..."
            sleep 10
          done
          echo "$HEALTH" | grep -q '"status":"ok"' || { echo "FAIL: /api/health after 5 attempts"; exit 1; }

          echo "Logging in to get JWT token..."
          LOGIN_BODY=$(jq -n --arg e "$SMOKE_EMAIL" --arg p "$SMOKE_PASSWORD" '{email:$e,password:$p}')
          LOGIN=$(curl -s -X POST https://houseboard.pages.dev/api/auth/login \
            -H "Content-Type: application/json" \
            -d "$LOGIN_BODY")
          TOKEN=$(echo "$LOGIN" | jq -r '.token // empty')
          [ -n "$TOKEN" ] || { echo "FAIL: login did not return token"; echo "$LOGIN"; exit 1; }
          echo "OK: got JWT token"

          echo "Testing /api/announcements (with JWT)..."
          ANNOUNCEMENTS=$(curl -sf -H "Authorization: Bearer $TOKEN" https://houseboard.pages.dev/api/announcements)
          echo "$ANNOUNCEMENTS" | grep -q '"id"' || { echo "FAIL: /api/announcements"; exit 1; }
          echo "OK: response contains announcements"

          echo "Testing /api/building (with JWT)..."
          BUILDING=$(curl -sf -H "Authorization: Bearer $TOKEN" https://houseboard.pages.dev/api/building)
          echo "$BUILDING" | grep -q '"name"' || { echo "FAIL: /api/building"; exit 1; }
          echo "OK: $BUILDING"

          echo "Testing public display endpoints (no auth)..."
          ANON_BUILDING=$(curl -sf https://houseboard.pages.dev/api/building)
          echo "$ANON_BUILDING" | grep -q '"name"' || { echo "FAIL: /api/building without auth"; exit 1; }
          echo "OK: /api/building accessible without auth (display/kiosk)"

          echo "Testing 401 without token on protected endpoint..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://houseboard.pages.dev/api/users)
          [ "$STATUS" = "401" ] || { echo "FAIL: expected 401, got $STATUS"; exit 1; }
          echo "OK: unauthenticated request to /api/users returns 401"

          echo "Testing / (HTML, no auth for static assets)..."
          HTML=$(curl -sf https://houseboard.pages.dev/)
          echo "$HTML" | grep -q '<div id="root">' || { echo "FAIL: / HTML"; exit 1; }
          echo "OK: HTML contains root div"

          echo "Testing security headers..."
          HEADERS=$(curl -sI https://houseboard.pages.dev/api/health)
          echo "$HEADERS" | grep -qi "x-frame-options: DENY" || { echo "FAIL: missing X-Frame-Options"; echo "$HEADERS"; exit 1; }
          echo "$HEADERS" | grep -qi "x-content-type-options: nosniff" || { echo "FAIL: missing X-Content-Type-Options"; echo "$HEADERS"; exit 1; }
          echo "$HEADERS" | grep -qi "strict-transport-security" || { echo "FAIL: missing HSTS"; echo "$HEADERS"; exit 1; }
          echo "$HEADERS" | grep -qi "content-security-policy-report-only" || { echo "FAIL: missing CSP-Report-Only"; echo "$HEADERS"; exit 1; }
          echo "OK: security headers present"

          echo "Testing rate limit does not trigger on single attempt..."
          RL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST https://houseboard.pages.dev/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"wrong@test.fi","password":"wrongpass"}')
          [ "$RL_STATUS" = "401" ] || { echo "FAIL: expected 401, got $RL_STATUS"; exit 1; }
          echo "OK: single failed login returns 401 (not 429)"

          echo "All smoke tests passed!"
